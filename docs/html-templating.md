# HTML テンプレートシステム

PeerCast YT では、`{@ ... }` 形式の実行時テンプレートタグに加えて、ビ
ルド時に処理されるテンプレートタグを追加して、ページ共通部分の変更やメッ
セージの翻訳が簡単にできるようにしてあります。

## テンプレートタグ

テンプレートタグは、開き波括弧 `{` で始まり、閉じ波括弧で `}` 終わりま
す。`{` に続く一文字の記号がタグの種類を表わしています。

<table>
<tr><td>^</td><td>マクロ</td></tr>
<tr><td>#</td><td>翻訳メッセージ</td></tr>
<tr><td>@</td><td>ディレクティブ、変数展開</td></tr>
<tr><td>!</td><td>変数展開(HTMLエスケープ無効)</td></tr>
<tr><td>\</td><td>変数展開(JavaScript文字列リテラル)</td></tr>
</table>

`html-master` ディレクトリ以下にある .html ファイルはまず マクロ展開さ
れ、その後翻訳メッセージの置換が行われて各国語版の HTML ファイルが用意
されます。

マクロ展開は、`ui/macro-exapand` スクリプトによって、翻訳メッセージの
置換は `ui/message-interpolate` スクリプトによってビルド時に行われます。

その他のタグの処理は実行時に行われます。

## マクロタグの文法と意味

`macro-expand` コマンドは一度に1つの入力ファイルを処理します。この入力
ファイルはマクロタグによって、別のファイルを取り込んだり、また逆に入力
ファイルを別のファイル(レイアウトファイル)の一部として埋め込むことがで
きます。

例えば、`ui` ディレクトリで以下のコマンドラインを実行すると、
`html-master/index.html` を処理した後の結果が標準出力に印刷されます。

    $ ./macro-expand html-master/index.html

`index.html` の最初の行は `{^define LAYOUT layout.html}` となっており、
これはレイアウトファイルとして `Templates/layout.html` を利用すること
を意味しています。

`{^define 変数名 値}` の形式のタグはマクロ変数に値を設定します。これは、
`{^define 変数名}値{^end}` のように書くこともできます。値を設定したマ
クロ変数は、`{^変数名}` の形式で展開することができます。

`{^include ファイル名}` の形式のタグは、`Templates/ファイル名` の内容
をその位置に展開します。

## 翻訳メッセージの挿入

HTML 中の自然言語のメッセージ(ラベルなど)は、`{#翻訳元メッセージ}` の
形式でタグ付けされ、`message-interpolate` スクリプトがこれをメッセージ
カタログの内容に従って、各国語に翻訳します。例えば：

    $ echo '{#_Information_navbar}' | ./message-interpolate -c catalogs/en.json
    Information
    $ echo '{#_Information_navbar}' | ./message-interpolate -c catalogs/ja.json
    情報

メッセージカタログは、`ui/catalogs/言語コード.json` にある JSON ファイ
ルです。このファイルは1つの JSON オブジェクトを含んでおり、キーが翻訳
元のメッセージ、値が翻訳後のメッセージになっています。

カタログファイルに翻訳元メッセージをキーとする項目が見付からない場合は、
翻訳元メッセージがそのまま出力されます。

     $ echo '{#nonexistent message}' | ./message-interpolate --verbose -c catalogs/ja.json
     Warning: translation for "nonexistent message" missing
     nonexistent message

## 実行時テンプレートタグ

実行時に処理されるテンプレートタグには、以下の形式のものがあります。

    {$変数名}
    {!変数名}
    {\変数名}
    {@キーワード...}

最初の3つの形式は、プログラム内の状態を表わす変数を、HTML 文書内に展開
します。`$` は HTML エスケープされ、`!` はそのまま埋め込まれます。`\`
はJavaScript の文字列中に展開するのに適当なように(バックスラッシュ記法
で)エスケープされます。

キーワードには、`if`, `else`, `end`, `loop`, `foreach`, `fragment` が
あります。

## 変数名

変数名は `servMgr.upgradeURL` のようなドットで区切られた単語です。

HTMLテンプレート変数は、内部的には諸々のクラスの `writeVariable` メソッ
ドが呼ばれて内容が決定します。上の例の場合、ServMgr クラスの
`writeVariable` メソッドが `upgradeURL` 変数の内容を出力します。

`servMgr`, `chanMgr`, `stats` はそれぞれプログラム内のグローバル変数に
対応しています。

特殊な変数として `loop.` で始まるものがあり、`loop` ブロック内で使われ
ます。

また `page` 変数はページのクエリー文字列で `id=...` で表わされる ID の
チャンネルを、`page.channel` でアクセスするために使われる。

## if ディレクティブ

`{@if 条件式1} 節1 [{@elsif 条件式2} 節2] ... [{@else} else節] {@end}`

条件式が上から順に評価され、最初に真になった条件式に対応する節が有効に
なる。どの条件式も偽になった場合、else 節があれば else 節が有効になる。

### 条件式が変数名の場合

変数の値は内部的には文字列だが、条件式で判定される場合には一定の規則に
従って真偽値に変換される。

1. 先頭が数字で始まっていれば、整数に変換され 0 の場合だけが偽として扱われる。
2. そうでなければ、空文字列は偽として扱われる。
3. そうでなければ真として扱われる。

先頭が数字の文字列から整数への変換は、atoi(3) 式に行なわれる。

また、変数名の先頭に任意の数の `!` を付けて真偽値を反転させることがで
きる。

### 条件式が比較演算の場合

`a == b`, `a == "c"` のような文字列比較をすることができる。ここで、
`a`, `b` は変数名、`"c"` は文字列リテラル。文字列が完全に一致していれ
ば真になる。

一致しない時に真になる `!=` 演算子もある。

### 条件式が正規表現マッチ式の場合

`a =~ "正規表現"` で、変数 a が正規表現にマッチすれば真に、さもなくば
偽になる。`=~` 演算子のかわりに `!~` 演算子を使えばマッチしなかった時
に真になる。

## loop ディレクティブ

`loop servMgr.numServents` のようにループする回数を変数名で指定する。

ブロック内では `loop.` で始まる変数が使えるようになる。

### loop.index

ループのインデックス。0 から始まる。

### loop.indexEven

ループのインデックスが偶数であるかどうか。

### コレクションへのアクセス

`loop.servent`, `loop.channel`, `loop.hit`, `loop.bcid`, `loop.filter`
で、それぞれ `loop.index` で表わされる位置のサーバント、チャンネル、ヒッ
ト[^1]、ブロードキャストID、フィルターにアクセスできる。

`loop.hit` の場合、どのチャンネルのヒットかは、クエリー文字列の
`id=...` で指定される。

[^1]: チャンネルをリレーしているノードの情報のこと。

## fragment ディレクティブ

ページの一部をフラグメントとして、名前を付けてマークする。

`foo.html` が以下の内容だったとすると、foo.html を取得した場合は A, B,
C の全てがレンダリングされる。

    A
    {@fragment foo}
    B
    {@end}
    C

クエリー文字列で `foo.html?fragment=foo` のようにフラグメントを指定し
た場合は、B の部分だけがレンダリングされる。
