# peercast HTML テンプレートシステム

## 概要

peercast の HTML テンプレートでは、ディレクティブを以下の形式で埋め込
むことができる。

    {$変数名}
    {!変数名}
    {\変数名}
    {@キーワード...}

変数名は `servMgr.upgradeURL` のようなドットで区切られた単語。この場合
プログラム内のグローバル変数である `servMgr` の `writeVariable` メソッ
ドが呼ばれて `upgradeURL` 変数の内容が文書に展開される。

変数名とその意味は、それぞれのオブジェクトが好きに決められる。第一単語
とプログラム内のオブジェクトのマッピングはハードコードされている。

`$` は HTML エスケープされ、`!` はそのまま埋め込まれる。`\` は
JavaScript の文字列中に展開するのに適当なようにエスケープされる。

キーワードには、`if`, `else`, `end`, `loop`, `foreach`, `fragment` が
ある。

## 変数名

`servMgr`, `chanMgr`, `stats` はそれぞれプログラム内のグローバル変数に
対応している。

特殊な変数として `loop` があり、`loop` ブロック内で i 番目の要素にアク
セスするために使われる。

また `page` 変数はページのクエリー文字列で `id=...` で表わされる ID の
チャンネルを、`page.channel` でアクセスするために使われる。

## if ディレクティブ

`{@if 条件式} A {@end}` あるいは、`{@if 条件式} A {@else} B {@end}` の
形で使われ、条件式の値が真ならば A の部分が有効になり、偽ならば B の部
分が有効になる。

### 条件式が変数名の場合

変数の値は内部的には文字列だが、条件式で判定される場合には一定の規則に
従って真偽値に変換される。

1. 先頭が数字で始まっていれば、整数に変換され 0 の場合だけが偽として扱われる。
2. そうでなければ、空文字列は偽として扱われる。
3. そうでなければ真として扱われる。

先頭が数字の文字列から整数への変換は、atoi(3) 式に行なわれる。

また、変数名の先頭に任意の数の `!` を付けて真偽値を反転させることがで
きる。

### 条件式が比較演算の場合

`a == b`, `a == "c"` のような文字列比較をすることができる。ここで、
`a`, `b` は変数名、`"c"` は文字列リテラル。文字列が完全に一致していれ
ば真になる。

一致しない時に真になる `!=` 演算子もある。

## loop ディレクティブ

`loop servMgr.numServents` のようにループする回数を変数名で指定する。

ブロック内では `loop.` で始まる変数が使えるようになる。

### loop.index

ループのインデックス。0 から始まる。

### loop.indexEven

ループのインデックスが偶数であるかどうか。

### コレクションへのアクセス

`loop.servent`, `loop.channel`, `loop.hit`, `loop.bcid`, `loop.filter`
で、それぞれ `loop.index` で表わされる位置のサーバント、チャンネル、ヒッ
ト[^1]、ブロードキャストID、フィルターにアクセスできる。

`loop.hit` の場合、どのチャンネルのヒットかは、クエリー文字列の
`id=...` で指定される。

[^1]: チャンネルをリレーしているノードの情報のこと。
